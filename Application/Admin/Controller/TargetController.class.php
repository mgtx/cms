<?php/** * Created by PhpStorm. * User: milo * Date: 15/3/23 * Time: 14:05 */namespace Admin\Controller;use Think\Controller;class TargetController extends AuthController{	function index(){	}	function yearTarget(){		$year = date('Y');		$yearsDate = $this->M_yearTarget->where(array('year'=>$year))->find();		if(IS_POST){			$date['year'] = $year;			$date['target'] = (int)I('target');			if($date['target']>0){				if(empty($yearsDate)){					$this->M_yearTarget->add($date);				}else{					$this->M_yearTarget->where("year={$year}")->save($date);				}				$yearsDate = $date;			}		}else{			if(empty($yearsDate)){				$yearsDate = array(						'year'	=>$year,						'target'=>0				);			}		}		$this->assign('yearsDate',$yearsDate);		$this->assign('Syn',$_SESSION['Syn']);		$this->display();	}	function monthTarget(){		$month = date('Y-m');		$monthDate = $this->M_monthTarget->where(array('month'=>$month))->find();		if(IS_POST){			$date['month'] = $month;			$date['target'] = (int)I('target');			if($date['target']>0){				if(empty($monthDate)){					$this->M_monthTarget->add($date);				}else{					$this->M_monthTarget->where("month='{$month}'")->save($date);				}				$monthDate = $date;			}		}else{			if(empty($monthDate)){				$monthDate = array(						'month'	=>$month,						'target'=>0				);			}		}		$this->assign('monthDate',$monthDate);		$this->assign('Syn',$_SESSION['Syn']);		$this->display();	}	function teamTarget(){		if(IS_POST){			list($where['dep_name'],$where['dep_id']) = explode('_',I('dep_name'));			$where['month'] = I('month');			$target = (int)I('target');			$target_team = $this->M_business_target_team->where($where)->find();			if($target_team){				$this->M_business_target_team->where($where)->save(array('target'=>$target));			}else{				$where['target'] = $target;				$this->M_business_target_team->add($where);			}		}		$month = date('Y-m');		$deps = $this->M_dep->where('status=1')->field('dep_id,dep_name')->select();//获取需要设置月目标的团队		$team_month_target = $this->M_business_target_team->where("month='{$month}'")->select();//获取需要设置月目标的团队		//var_dump($deps);		$this->assign('deps',$deps);		$this->assign('team_month_target',$team_month_target);		$this->assign('month',$month);		$this->assign('Syn',$_SESSION['Syn']);		$this->display();	}	function personageTarget(){		$month = date('Y-m');		$deps = $this->M_dep->where('status=1')->field('dep_id,dep_name')->select();//获取需要设置月目标的团队		//团队成员		foreach($deps as $id => $dep){			$users[$id][dep] = $dep[dep_name];			$users[$id][users] = $this->M_mployee->where(array('dep_now'=>$dep['dep_id']))->field('userid,name')->select();		}		//获取当月的个人目标		foreach($users as $key=> $suer){			foreach($suer[users] as $k=>$u){				$where =array('name'=>$u[name],'month'=>$month);				//$users[$key][users][$k]['target']				 $target =  $this->M_business_target_personage->where($where)->field('target')->find()[target];				if($target){					$users[$key][users][$k]['target'] = $target;				}else{					$users[$key][users][$k]['target'] = 0;				}			}		}		$this->assign('users',$users);		$this->assign('month',$month);		$this->assign('num',0);		$this->assign('Syn',$_SESSION['Syn']);		$this->display();	}	function personageAjax(){		if(IS_AJAX){			$personage[userid]	=	$where[userid]	 =	 I('userid');			$personage[name]	=	$where[name]	 =	 I('name');			$personage[month] 	=	$where[month]  	=	date('Y-m');			$personage[target] 	= 	(int)I('target');			if($personage[target] <= 0){				$_date = array(						'code'=>0,						'msg'=>'请填写大于0目标额'				);				$this->Ajaxreturn($_date);			}			if($this->M_business_target_personage->where($where)->find()){				if($this->M_business_target_personage->where($where)-> save($personage)){					$code 	= 	1;					$msg 	=	$where[name].$where[month].'月目标修改成功';				}else{					$code 	= 	-1;					$msg 	=	$where[name].$where[month].'月目标修改失败';				}			}else{				if($s = $this->M_business_target_personage->add($personage)){					$code 	=	2;					$msg	=	$where[name].$where[month].'月目标修改月目标成功';				}else{					$code	=	-2;					$msg	=	$where[name].$where[month].'月目标修改月目标失败';				}			}			$_date = array(					'code'=>$code,					'msg'=>$msg			);			$this->Ajaxreturn($_date);		}	}	function personagePost(){		if(IS_POST){			$userIds 	= 	explode(',',I('userids'));			$names 		= 	explode(',',I('names'));			$targets 	=   explode(',',I('targets'));			$month 		=   date('Y-m');			foreach($names as $key=>$name){				$where = array('userid'=>$userIds[$key],'name'=>$name,'month'=>$month);				if($this->M_business_target_personage->where($where)->find()){					$this->M_business_target_personage->where($where)->save(array('target'=>(int)$targets[$key]));				}else{					$where['target'] = $targets[$key];					$this->M_business_target_personage->add($where);				}			}			$this->success('批量修改成功',U('Target/personageTarget'),1);		}	}}